rules_version = '2';

// ThankATech Firestore Security Rules - Production Ready
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions for security
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    function isValidEmail(email) {
      return email.matches('^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$');
    }
    
    // Clients collection
    match /clients/{clientId} {
      // Anyone authenticated can read basic client info (for displaying sender info)
      allow get: if isAuthenticated();
      
      // Allow querying - users can list all clients (needed for sender info display)
      // Security note: Client profiles should contain minimal public info
      allow list: if isAuthenticated();
      
      // Users can create their own client profile
      allow create: if isAuthenticated() 
                    && request.resource.data.authUid == request.auth.uid
                    && isValidEmail(request.resource.data.email);
      
      // Users can only update their own client profile
      allow update: if isAuthenticated() 
                    && resource.data.authUid == request.auth.uid
                    && request.resource.data.authUid == resource.data.authUid  // Can't change authUid
                    && request.resource.data.email == resource.data.email;     // Can't change email
      
      // Users can deactivate their own profile
      allow delete: if isAuthenticated() && resource.data.authUid == request.auth.uid;
    }
    
    // Technicians collection
    match /technicians/{techId} {
      // Anyone can read technician profiles (public browsing - needed for homepage)
      allow read, list: if true;
      
      // Users can create their own technician profile
      allow create: if isAuthenticated() 
                    && request.resource.data.authUid == request.auth.uid
                    && isValidEmail(request.resource.data.email);
      
      // Technicians can update their own profile (except sensitive fields)
      allow update: if isAuthenticated() 
                    && resource.data.authUid == request.auth.uid
                    && request.resource.data.authUid == resource.data.authUid     // Can't change authUid
                    && request.resource.data.email == resource.data.email        // Can't change email
                    && request.resource.data.totalThankYous == resource.data.totalThankYous; // Can't manually change counter
      
      // Technicians can deactivate their own profile
      allow delete: if isAuthenticated() && resource.data.authUid == request.auth.uid;
    }
    
    // Admins collection
    match /admins/{adminId} {
      // Admins can read individual admin profiles
      allow get: if isAdmin();
      
      // Allow authenticated users to query admins collection (needed for profile lookup)
      // Returns empty if not an admin, returns admin doc if user is admin
      allow list: if isAuthenticated();
      
      // Only existing admins can create new admin profiles
      allow create: if isAdmin();
      
      // Admins can update their own profile
      allow update: if isAuthenticated() && resource.data.authUid == request.auth.uid && isAdmin();
      
      // No deletion of admin profiles
      allow delete: if false;
    }
    
    // Token Transactions collection (main transaction log)
    match /tokenTransactions/{transactionId} {
      // TEMPORARY: Allow all authenticated reads for debugging
      // TODO: Restore stricter rules after fixing user data
      allow read, list: if isAuthenticated();
      
      // Only authenticated users can create token transactions
      allow create: if isAuthenticated() 
                    && request.resource.data.fromUserId == request.auth.uid
                    && (request.resource.data.type == 'thank_you' || 
                        request.resource.data.type == 'toa' ||
                        request.resource.data.type == 'token_purchase')
                    && request.resource.data.tokens > 0;
      
      // No updates or deletes (transactions are immutable)
      allow update, delete: if false;
    }
    
    // Thank Yous collection (appreciation messages)
    match /thankYous/{thankYouId} {
      // Users can read thank yous they sent or received (individual documents)
      allow get: if isAuthenticated() && 
                  (resource.data.fromUserId == request.auth.uid || 
                   resource.data.toTechnicianId == request.auth.uid);
      
      // Allow querying (will be filtered by where clauses in app)
      allow list: if isAuthenticated();
      
      // Authenticated users can create thank yous
      allow create: if isAuthenticated() 
                    && request.resource.data.fromUserId == request.auth.uid
                    && request.resource.data.toTechnicianId != request.auth.uid; // Prevent self-thank yous
      
      // Admins can read all thank yous
      allow get, list: if isAdmin();
      
      // No updates or deletes (thank yous are immutable)
      allow update, delete: if false;
    }
    
    // Tips collection (monetary tips)
    match /tips/{tipId} {
      // Users can read tips they sent or received (individual documents)
      allow get: if isAuthenticated() && 
                  (resource.data.fromUserId == request.auth.uid || 
                   resource.data.toTechnicianId == request.auth.uid);
      
      // Allow querying (will be filtered by where clauses in app)
      allow list: if isAuthenticated();
      
      // Authenticated users can create tips
      allow create: if isAuthenticated() 
                    && request.resource.data.fromUserId == request.auth.uid
                    && request.resource.data.amount > 0
                    && request.resource.data.toTechnicianId != request.auth.uid; // Prevent self-tips
      
      // Admins can read all tips
      allow get, list: if isAdmin();
      
      // Only admins can update tips (for payout status)
      allow update: if isAdmin();
      
      // No deletes (tips are immutable)
      allow delete: if false;
    }
    
    // Token Balances collection (user balances)
    match /tokenBalances/{userId} {
      // TEMPORARY: Allow all authenticated users to read any balance for debugging
      // TODO: Restore to allow read: if isOwner(userId) after fixing
      allow read: if isAuthenticated();
      
      // Only server-side functions or admins can modify balances
      allow write: if false;
    }
    
    // Daily Thank You Limits collection (rate limiting)
    match /dailyThankYouLimits/{limitId} {
      // Users can read their own limits
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Admins can read all limits
      allow read: if isAdmin();
      
      // Only system can write limits (server-side enforcement)
      allow write: if false;
    }
    
    // Business Claims collection (business verification requests)
    match /businessClaims/{claimId} {
      // Users can read their own claims
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Authenticated users can create claims
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // Admins can read and update all claims
      allow read, update: if isAdmin();
      
      // No deletes
      allow delete: if false;
    }
    
    // Email Logs collection (for debugging email issues)
    match /emailLogs/{logId} {
      // Users can read their own email logs
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Admins can read all email logs
      allow read: if isAdmin();
      
      // Only system can write email logs
      allow write: if false;
    }
    
    // Stripe Payments collection (payment records)
    match /stripePayments/{paymentId} {
      // Users can read their own payment records
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Admins can read all payment records
      allow read: if isAdmin();
      
      // Only system can write payment records (via webhooks)
      allow write: if false;
    }
    
    // System Logs collection (for debugging and monitoring)
    match /systemLogs/{logId} {
      // Only admins can read system logs
      allow read: if isAdmin();
      
      // Only system can write logs
      allow write: if false;
    }
    
    // Profile Photos in Storage (handled by storage.rules)
    // But we can track metadata here
    match /profilePhotoMetadata/{userId} {
      // Users can read/write their own photo metadata
      allow read, write: if isOwner(userId);
      
      // Admins can read all photo metadata
      allow read: if isAdmin();
    }
    
    // User Sessions (for security tracking)
    match /userSessions/{sessionId} {
      // Users can read their own sessions
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Admins can read all sessions
      allow read: if isAdmin();
      
      // System manages sessions
      allow write: if false;
    }
    
    // EXPLICIT DENY: All other collections are blocked by default
    // This prevents access to any undefined collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
