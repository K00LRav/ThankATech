<!DOCTYPE html>
<html>
<head>
  <title>Firestore Rules Test</title>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Your Firebase config (from your app)
    const firebaseConfig = {
      apiKey: "AIzaSyDpyi3T-0bPj8V_kZmB9x8UqEJUdVOD0KY",
      authDomain: "thankatech.firebaseapp.com",
      projectId: "thankatech",
      storageBucket: "thankatech.firebasestorage.app",
      messagingSenderId: "1097127535877",
      appId: "1:1097127535877:web:de6f0e5b0c89a5e6e01d7d",
      measurementId: "G-Z6XDFH7BYN"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    window.testAuth = async function() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const output = document.getElementById('output');
      
      try {
        output.innerHTML = 'Signing in...<br>';
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        output.innerHTML += `✅ Signed in as: ${userCredential.user.email}<br>`;
        output.innerHTML += `User UID: ${userCredential.user.uid}<br><br>`;

        // Test 1: Read technicians
        output.innerHTML += 'Testing technicians collection (public read)...<br>';
        try {
          const techQuery = query(collection(db, 'technicians'));
          const techSnap = await getDocs(techQuery);
          output.innerHTML += `✅ Technicians: Read ${techSnap.size} documents<br><br>`;
        } catch (e) {
          output.innerHTML += `❌ Technicians: ${e.message}<br><br>`;
        }

        // Test 2: Query clients by authUid
        output.innerHTML += 'Testing clients query by authUid...<br>';
        try {
          const clientQuery = query(collection(db, 'clients'), where('authUid', '==', userCredential.user.uid));
          const clientSnap = await getDocs(clientQuery);
          output.innerHTML += `✅ Clients: Found ${clientSnap.size} documents<br><br>`;
        } catch (e) {
          output.innerHTML += `❌ Clients: ${e.message}<br><br>`;
        }

        // Test 3: Query tokenTransactions
        output.innerHTML += 'Testing tokenTransactions query...<br>';
        try {
          const txQuery = query(collection(db, 'tokenTransactions'), where('fromUserId', '==', userCredential.user.uid));
          const txSnap = await getDocs(txQuery);
          output.innerHTML += `✅ TokenTransactions: Found ${txSnap.size} documents<br><br>`;
        } catch (e) {
          output.innerHTML += `❌ TokenTransactions: ${e.message}<br><br>`;
        }

        // Test 4: Check auth token
        output.innerHTML += 'Checking auth token...<br>';
        const token = await userCredential.user.getIdToken();
        output.innerHTML += `Token length: ${token.length} characters<br>`;
        output.innerHTML += `Token starts with: ${token.substring(0, 20)}...<br>`;

      } catch (error) {
        output.innerHTML += `❌ Error: ${error.message}<br>`;
        console.error(error);
      }
    };
  </script>
</head>
<body>
  <h1>Firestore Rules Test</h1>
  <div style="margin: 20px;">
    <input type="email" id="email" placeholder="Email" style="width: 300px; padding: 8px;"><br><br>
    <input type="password" id="password" placeholder="Password" style="width: 300px; padding: 8px;"><br><br>
    <button onclick="testAuth()" style="padding: 10px 20px; font-size: 16px;">Test Access</button>
  </div>
  <div id="output" style="margin: 20px; padding: 20px; background: #f0f0f0; font-family: monospace; white-space: pre-wrap;"></div>
</body>
</html>
